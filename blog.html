<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio de Jonas Agra</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="/icons/favicons/chest.ico" type="image/x-icon">
    <meta name="description" content="Meu di√°rio pessoal - pensamentos, experi√™ncias e opini√µes.">
    <link rel="preload" href="/fonts/Minecraft.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/Minecraft-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/MinecraftFive-Bold.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/fonts/MinecraftFive-Bold.woff" as="font" type="font/woff2" crossorigin>
<body>
    <!-- Navigation Menu -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-links">
                <a href="index.html" class="nav-link" title="In√≠cio">
                    <img src="/icons/home.webp" alt="In√≠cio" class="nav-icon">
                </a>
                <a href="blog.html" class="nav-link active" title="Blog">
                    <img src="/icons/journal.webp" alt="Blog" class="nav-icon">
                </a>
                <a href="/panel/admin.html" class="nav-link nav-admin" title="Admin" style="display: none;">
                    <img src="/icons/redstone-sysop.webp" alt="Admin" class="nav-icon-admin">
                </a>
            </div>
        </div>
    </nav>

    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Main Container -->
    <main class="main-container blog-container">
        <!-- Blog Header -->
        <section class="blog-header">
            <h1 class="blog-title">Meu di√°rio pessoal</h1>
            <p class="blog-subtitle">Pensamentos, experi√™ncias e dia a dia</p>
        </section>

        <!-- Blog Posts Grid -->
        <section class="blog-posts" id="blog-posts">
            <!-- Posts ser√£o carregados via JavaScript -->
            <p class="no-posts" id="no-posts">Carregando posts...</p>
        </section>
    </main>

    <!-- Footer with iOS Glass Effect -->
    <footer class="footer-glass">
        <div class="footer-content">
            <div class="contact-info">
            <p class="copyright">¬© 2026 Jonas Agra - Corelakes</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const blogPosts = document.getElementById('blog-posts');
        const noPosts = document.getElementById('no-posts');
        let isLoggedIn = false;
        let supabaseClient = null;
        
        // Check admin authentication and show/hide admin link
        function checkAdminAuth() {
            const isAuthenticated = localStorage.getItem('admin_authenticated') === 'true';
            const adminLink = document.querySelector('.nav-admin');
            
            if (adminLink) {
                if (isAuthenticated) {
                    adminLink.style.display = 'flex';
                } else {
                    adminLink.style.display = 'none';
                }
            }
        }

        // Run on page load
        checkAdminAuth();
        
        // Get Supabase config from localStorage
// Get Supabase config from localStorage or use public credentials
            function getSupabaseConfig() {
                return {
                    url: localStorage.getItem('supabase_url') || 'https://nkrpxjlixrpvmvkyzobf.supabase.co',
                    key: localStorage.getItem('supabase_key') || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5rcnB4amxpeHJwdm12a3l6b2JmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyOTU1ODAsImV4cCI6MjA4NDg3MTU4MH0.EvfrUfAQKQo-scZ487m4nT2FyUggYDpavD1YTUZhfWs'
                };
            }
        
        // Check if user is logged in (admin)
        async function checkAuth() {
            const config = getSupabaseConfig();
            if (!config.url || !config.key) return false;
            
            try {
                if (!supabaseClient) {
                    supabaseClient = window.supabase.createClient(config.url, config.key);
                }
                const { data: { session } } = await supabaseClient.auth.getSession();
                return !!session;
            } catch (error) {
                return false;
            }
        }
        
        // Load posts from Supabase (P√öBLICO)
        async function loadPosts() {
            const config = getSupabaseConfig();
            
            // Check if logged in (for admin buttons)
            isLoggedIn = await checkAuth();
            
            // Try Supabase first (even for anonymous users)
            if (config.url && config.key) {
                try {
                    if (!supabaseClient) {
                        supabaseClient = window.supabase.createClient(config.url, config.key);
                    }
                    
                    // IMPORTANTE: Buscar posts SEM autentica√ß√£o (p√∫blico)
                    const { data: posts, error } = await supabaseClient
                        .from('posts')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        console.error('Erro ao carregar posts do Supabase:', error);
                        loadFromLocalStorage();
                        return;
                    }
                    
                    if (!posts || posts.length === 0) {
                        noPosts.textContent = 'Nenhum post publicado ainda.';
                        noPosts.style.display = 'block';
                        return;
                    }
                    
                    noPosts.style.display = 'none';
                    renderPosts(posts);
                    
                    // Sync to localStorage for offline access
                    syncToLocalStorage(posts);
                    
                } catch (error) {
                    console.error('Erro ao conectar com Supabase:', error);
                    loadFromLocalStorage();
                }
            } else {
                // Fallback to localStorage if no Supabase config
                loadFromLocalStorage();
            }
        }
        
        // Fallback: Load from localStorage
        function loadFromLocalStorage() {
            const posts = JSON.parse(localStorage.getItem('blog_posts') || '[]');
            
            if (posts.length === 0) {
                noPosts.textContent = 'Nenhum post publicado ainda.';
                noPosts.style.display = 'block';
                return;
            }
            
            noPosts.style.display = 'none';
            renderPosts(posts);
        }
        
        // Sync posts to localStorage
        function syncToLocalStorage(posts) {
            const formattedPosts = posts.map(post => ({
                id: post.id,
                title: post.title,
                slug: post.slug,
                content: post.content,
                excerpt: post.excerpt,
                image_url: post.image_url,
                date: post.date || new Date(post.created_at).toLocaleDateString('pt-BR'),
                created_at: post.created_at
            }));
            localStorage.setItem('blog_posts', JSON.stringify(formattedPosts));
        }
        
        // Render posts to page
        function renderPosts(posts) {
            // Clear existing posts
            const existingPosts = blogPosts.querySelectorAll('.blog-post');
            existingPosts.forEach(post => post.remove());
            
            // Render posts
            posts.forEach(post => {
                const excerpt = post.excerpt || (post.content.length > 150 
                    ? post.content.replace(/<[^>]*>/g, '').substring(0, 150) + '...' 
                    : post.content.replace(/<[^>]*>/g, ''));
                
                const postDate = post.date || new Date(post.created_at).toLocaleDateString('pt-BR');
                
                const postElement = document.createElement('article');
                postElement.className = 'blog-post';
                postElement.innerHTML = `
                    ${isLoggedIn ? `
                        <div class="post-admin-actions">
                            <button class="admin-action-btn edit-btn" onclick="editPost('${post.slug}')" title="Editar">‚úèÔ∏è</button>
                            <button class="admin-action-btn delete-btn" onclick="deletePost(${post.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    ` : ''}
                    ${post.image_url ? `
                        <div class="post-image">
                            <img src="${post.image_url}" alt="${escapeHtml(post.title)}">
                        </div>
                    ` : ''}
                    <div class="post-content">
                        <a href="posts.html?slug=${post.slug}" style="text-decoration: none; color: inherit;">
                            <h2 class="post-title">${escapeHtml(post.title)}</h2>
                        </a>
                        <p class="post-excerpt">${escapeHtml(excerpt)}</p>
                        <div class="post-meta">
                            <span class="post-date">üìÖ ${postDate}</span>
                        </div>
                    </div>
                `;
                blogPosts.appendChild(postElement);
            });
        }
        
        // Edit post - redirect to edit page
        function editPost(postSlug) {
            window.location.href = '/edit.html?slug=' + postSlug;
        }
        
        // Delete post (only for logged in users)
        async function deletePost(postId) {
            if (!confirm('Tem certeza que deseja excluir este post?')) return;
            
            try {
                const { error } = await supabaseClient
                    .from('posts')
                    .delete()
                    .eq('id', postId);
                
                if (error) throw error;
                
                alert('Post exclu√≠do com sucesso!');
                loadPosts();
                
            } catch (error) {
                alert('Erro ao excluir: ' + error.message);
            }
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load posts on page load
        loadPosts();
    </script>
</body>
</html>