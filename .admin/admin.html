<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Corelakes</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="https://minecraft.wiki/images/Corelakes_pfp_avatar.png?84b72" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Navigation Menu -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-links">
                <a href="index.html" class="nav-link" title="In√≠cio">
                    <img src="https://minecraft.wiki/images/Grass_Block_%28item%29_BE2.png" alt="In√≠cio" class="nav-icon">
                </a>
                <a href="blog.html" class="nav-link" title="Blog">
                    <img src="https://minecraft.wiki/images/Book_and_Quill_JE2_BE2.gif" alt="Blog" class="nav-icon">
                </a>
                <a href="admin.html" class="nav-link active nav-admin" title="Admin">
                    <img src="https://minecraft.wiki/images/Invicon_Redstone.gif" alt="Admin" class="nav-icon">
                </a>
            </div>
        </div>
    </nav>

    <div class="particles-container">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Main Container -->
    <main class="main-container admin-container">
        <!-- Config Section (shown first time) -->
        <section id="config-section" class="admin-section">
            <h1 class="admin-title">‚öôÔ∏è Configura√ß√£o do Supabase</h1>
            <p class="admin-description">Configure suas credenciais do Supabase. Elas ser√£o salvas de forma segura no seu navegador.</p>
            
            <div class="admin-form">
                <label class="admin-label">URL do Projeto</label>
                <input type="text" id="supabase-url" placeholder="https://xxxxx.supabase.co" class="admin-input">
                
                <label class="admin-label">Anon Key</label>
                <input type="text" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="admin-input">
                
                <button id="save-config-btn" class="admin-btn publish">Salvar Configura√ß√£o</button>
            </div>
            
            <div class="admin-help">
                <h3>üìã Como obter as credenciais:</h3>
                <ol>
                    <li>Acesse <a href="https://supabase.com" target="_blank">supabase.com</a> e fa√ßa login</li>
                    <li>Crie um novo projeto ou selecione um existente</li>
                    <li>V√° em Settings ‚Üí API</li>
                    <li>Copie a "Project URL" e a "anon public" key</li>
                    <li>Crie uma tabela "posts" com: id (int8), title (text), content (text), created_at (timestamptz)</li>
                </ol>
            </div>
        </section>

        <!-- Login Section -->
        <section id="login-section" class="admin-section hidden">
            <h1 class="admin-title">üîí √Årea Restrita</h1>
            <p class="admin-description">Fa√ßa login com sua conta Supabase</p>
            
            <div class="admin-form">
                <label class="admin-label">E-mail</label>
                <input type="email" id="login-email" placeholder="seu@email.com" class="admin-input">
                
                <label class="admin-label">Senha</label>
                <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="admin-input">
                
                <button id="login-btn" class="admin-btn publish">Entrar</button>
                
                <p class="admin-note">
                    <button id="reset-config-btn" class="admin-link">Reconfigurar Supabase</button>
                </p>
            </div>
        </section>

        <!-- Editor Section -->
        <section id="editor-section" class="admin-section hidden">
            <div class="editor-header">
                <h1 class="admin-title">üìù Novo Post</h1>
                <button id="logout-btn" class="admin-btn logout">Sair</button>
            </div>
            
            <div class="admin-form">
                <label class="admin-label">T√≠tulo</label>
                <input type="text" id="post-title" placeholder="T√≠tulo do post" class="admin-input">
                
                <label class="admin-label">Conte√∫do</label>
                <textarea id="post-content" placeholder="Escreva seu post aqui..." class="admin-textarea"></textarea>
                
                <button id="publish-btn" class="admin-btn publish">Publicar</button>
            </div>

            <!-- Posts List -->
            <div class="posts-manager">
                <h2 class="admin-subtitle">üìö Seus Posts</h2>
                <div id="posts-list" class="posts-list">
                    <p class="loading">Carregando posts...</p>
                </div>
            </div>
        </section>

        <!-- Status Messages -->
        <div id="status-message" class="status-message hidden"></div>
    </main>

    <!-- Footer -->
    <footer class="footer-glass">
        <div class="footer-content">
            <p class="copyright">¬© 2026 Jonas Agra - Corelakes</p>
        </div>
    </footer>

    <script>
        // ============================================
        // SUPABASE INTEGRATION
        // ============================================
        
        let supabase = null;
        let currentUser = null;
        
        // DOM Elements
        const configSection = document.getElementById('config-section');
        const loginSection = document.getElementById('login-section');
        const editorSection = document.getElementById('editor-section');
        const statusMessage = document.getElementById('status-message');
        
        // Config elements
        const supabaseUrlInput = document.getElementById('supabase-url');
        const supabaseKeyInput = document.getElementById('supabase-key');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const resetConfigBtn = document.getElementById('reset-config-btn');
        
        // Login elements
        const loginEmailInput = document.getElementById('login-email');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Editor elements
        const postTitleInput = document.getElementById('post-title');
        const postContentInput = document.getElementById('post-content');
        const publishBtn = document.getElementById('publish-btn');
        const postsList = document.getElementById('posts-list');
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        function init() {
            const config = getStoredConfig();
            
            if (config.url && config.key) {
                initSupabase(config.url, config.key);
                checkSession();
            } else {
                showSection('config');
            }
        }
        
        function getStoredConfig() {
            return {
                url: localStorage.getItem('supabase_url') || '',
                key: localStorage.getItem('supabase_key') || ''
            };
        }
        
        function initSupabase(url, key) {
            supabase = window.supabase.createClient(url, key);
        }
        
        async function checkSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    showSection('editor');
                    loadPosts();
                } else {
                    showSection('login');
                }
            } catch (error) {
                showStatus('Erro ao verificar sess√£o: ' + error.message, 'error');
                showSection('login');
            }
        }
        
        // ============================================
        // UI HELPERS
        // ============================================
        
        function showSection(section) {
            configSection.classList.add('hidden');
            loginSection.classList.add('hidden');
            editorSection.classList.add('hidden');
            
            if (section === 'config') configSection.classList.remove('hidden');
            if (section === 'login') loginSection.classList.remove('hidden');
            if (section === 'editor') editorSection.classList.remove('hidden');
        }
        
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.classList.remove('hidden');
            
            setTimeout(() => {
                statusMessage.classList.add('hidden');
            }, 4000);
        }
        
        // ============================================
        // EVENT HANDLERS
        // ============================================
        
        // Save Supabase config
        saveConfigBtn.addEventListener('click', () => {
            const url = supabaseUrlInput.value.trim();
            const key = supabaseKeyInput.value.trim();
            
            if (!url || !key) {
                showStatus('Preencha a URL e a Key!', 'error');
                return;
            }
            
            localStorage.setItem('supabase_url', url);
            localStorage.setItem('supabase_key', key);
            
            initSupabase(url, key);
            showStatus('Configura√ß√£o salva!', 'success');
            showSection('login');
        });
        
        // Reset config
        resetConfigBtn.addEventListener('click', () => {
            localStorage.removeItem('supabase_url');
            localStorage.removeItem('supabase_key');
            supabaseUrlInput.value = '';
            supabaseKeyInput.value = '';
            showSection('config');
        });
        
        // Login
        loginBtn.addEventListener('click', async () => {
            const email = loginEmailInput.value.trim();
            const password = loginPasswordInput.value.trim();
            
            if (!email || !password) {
                showStatus('Preencha e-mail e senha!', 'error');
                return;
            }
            
            try {
                loginBtn.textContent = 'Entrando...';
                loginBtn.disabled = true;
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                showStatus('Login realizado!', 'success');
                showSection('editor');
                loadPosts();
                
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            } finally {
                loginBtn.textContent = 'Entrar';
                loginBtn.disabled = false;
            }
        });
        
        // Enter key for login
        loginPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loginBtn.click();
        });
        
        // Logout
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            currentUser = null;
            showSection('login');
            showStatus('Voc√™ saiu!', 'info');
        });
        
        // Publish post
        publishBtn.addEventListener('click', async () => {
            const title = postTitleInput.value.trim();
            const content = postContentInput.value.trim();
            
            if (!title || !content) {
                showStatus('Preencha t√≠tulo e conte√∫do!', 'error');
                return;
            }
            
            try {
                publishBtn.textContent = 'Publicando...';
                publishBtn.disabled = true;
                
                const { data, error } = await supabase
                    .from('posts')
                    .insert([{ 
                        title: title, 
                        content: content,
                        created_at: new Date().toISOString()
                    }])
                    .select();
                
                if (error) throw error;
                
                // Also save to localStorage for blog.html
                saveToLocalStorage(data[0]);
                
                postTitleInput.value = '';
                postContentInput.value = '';
                
                showStatus('Post publicado!', 'success');
                loadPosts();
                
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            } finally {
                publishBtn.textContent = 'Publicar';
                publishBtn.disabled = false;
            }
        });
        
        // ============================================
        // POSTS MANAGEMENT
        // ============================================
        
        async function loadPosts() {
            try {
                const { data, error } = await supabase
                    .from('posts')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                renderPostsList(data);
                syncToLocalStorage(data);
                
            } catch (error) {
                postsList.innerHTML = '<p class="error">Erro ao carregar posts: ' + error.message + '</p>';
            }
        }
        
        function renderPostsList(posts) {
            if (!posts || posts.length === 0) {
                postsList.innerHTML = '<p class="no-posts-admin">Nenhum post ainda.</p>';
                return;
            }
            
            postsList.innerHTML = posts.map(post => `
                <div class="post-item">
                    <div class="post-item-info">
                        <h3>${escapeHtml(post.title)}</h3>
                        <span class="post-item-date">${formatDate(post.created_at)}</span>
                    </div>
                    <button class="delete-btn" onclick="deletePost(${post.id})">üóëÔ∏è</button>
                </div>
            `).join('');
        }
        
        async function deletePost(id) {
            if (!confirm('Excluir este post?')) return;
            
            try {
                const { error } = await supabase
                    .from('posts')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                showStatus('Post exclu√≠do!', 'success');
                loadPosts();
                
            } catch (error) {
                showStatus('Erro: ' + error.message, 'error');
            }
        }
        
        // Sync posts to localStorage for blog.html to read
        function syncToLocalStorage(posts) {
            const formattedPosts = posts.map(post => ({
                id: post.id,
                title: post.title,
                content: post.content,
                date: formatDate(post.created_at),
                fullDate: post.created_at
            }));
            localStorage.setItem('blog_posts', JSON.stringify(formattedPosts));
        }
        
        function saveToLocalStorage(post) {
            const posts = JSON.parse(localStorage.getItem('blog_posts') || '[]');
            posts.unshift({
                id: post.id,
                title: post.title,
                content: post.content,
                date: formatDate(post.created_at),
                fullDate: post.created_at
            });
            localStorage.setItem('blog_posts', JSON.stringify(posts));
        }
        
        // ============================================
        // UTILITIES
        // ============================================
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Make deletePost available globally
        window.deletePost = deletePost;
        
        // Initialize on load
        init();
    </script>
</body>
</html>
